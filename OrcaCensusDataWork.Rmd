---
title: "Orca Census Data Work"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(lme4)
```

```{r}
orcaCensus <- read.csv(here("NRKW Population 1.csv"))
#orcapop<-read.csv("C:/Users/Owner/Desktop/fall 23'/EEB 313/NRKW Population 1.csv")
```

# Salmon Data Gen

The orca census data does not include this so we have to generate this still

Okay so based on Salmon data collection from 
https://www.npafc.org/wp-content/uploads/Public-Documents/2009/1199Rev1WGSA.pdf
pg - 51 (BC Chum Salmon)

For each year from 1980 to 2010 need to randomly select a salmon quantity.
Hypothetically, the abundance would go down towards the 2000's but for this beginning function I'm just gonna have it choose randomly.

Data set above:
Min value: 0.46 (million)
Max Value: 6.17 (million)

## Chum Generator
```{r}
years_measured<-(c(seq(1980,2010,1)))
#Numbers are in values of Millions of Fish
chum_generator <- function(){
  chum_density <- sample(x = seq(0.46,6.17,0.02), size = length(years_measured), replace = T) #choosing a random value between the range of 0.46 to 6.17, Replacing is True
  yearly_chum <- data.frame(years_measured, chum_density) #making data frame for each year and with the random density
    return(yearly_chum)
  }
  
#chum_generator()
```

## Chinook Generator
Based on https://www.npafc.org/wp-content/uploads/Public-Documents/2009/1199Rev1WGSA.pdf
pg 123
From 1980- 2008 (in millions of fish)
Min value: 0.13
Max Value: 1.27

```{r}
#Numbers are in values of Millions of Fish
chinook_generator <- function(){
  chinook_density <- sample(x = seq(0.13,1.27,0.02), size = length(years_measured), replace = T) #choosing a random value between the range of 0.46 to 6.17, Replacing is True
  yearly_chinook <- data.frame(years_measured, chinook_density) #making data frame for each year and with the random density
    return(yearly_chinook)
  }
  
#chinook_generator()
```

## Generator for Salmon in DF format
```{r}
salmon <- data.frame(chinook_generator(), chum_generator())

salmon_data<-salmon %>% 
  select(years_measured,chinook_density,chum_density) %>% 
  mutate(total_salmon = chinook_density + chum_density) 
```

# Orca Census Data

## Exploratory Plotting
```{r}
# library(ggplot2)
#  
# ggplot(data = orcapop, aes(x = Females_fecund_available)) +
#   geom_histogram()
# 
# ggplot (data = orcapop, aes(x = Pregnancy_count)) +
#   geom_histogram()
# 
# #measure of lactating 
# 
# ggplot(data = orcapop, aes(x = Females_fecund_unavailable)) +
#   geom_histogram()
# 
# ggplot(data = orcapop, aes(x = Birth_count)) +
#   geom_histogram()
# 

```

## Data Wrangling and Splitting for Pods

```{r Wrangling Pod Data}
#pods_Census_Data <- data.frame()
pods_List <- c(20,18,18,20,21,17,16,21,21,20,21,20,24,26,25,25,
               25,25,24,25,25,25,24,21,22,23,23,25,25,23,24)
# for(i in 1:31){
#   year <- i+1979
#   pods_Census_Data[i,1] <- year
#   pods_Census_Data[i,2] <- pods_List[i]
#   pods_Census_Data[i,3] <- (orcaCensus$Size_best[orcaCensus$YEAR==(year)]
#                             /pods_List[i])
#   pods_Census_Data[i,4] <- 
#     (orcaCensus$Females_fecund_unavailable[orcaCensus$YEAR==(year)]
#                             /pods_List[i])
# }
# colnames(pods_Census_Data) <- c("Year", "Pod_Count", 
#                                 "Avg_Orcas_Per_Pod", "Avg_Fecund_Unav_Per_Pod")

pods_Data <- data.frame() # create a data frame to hold the estimated pod data
x <- 1
i <- 1
while(x < 692){
  year <- i+1979
  pods_Data[c(x:((x-1)+pods_List[i])),1] <- year # add the year for each row
  pods_Data[c(x:((x-1)+pods_List[i])),2] <- c(1:pods_List[i]) #add a pod number
  x <- x+pods_List[i]
  i <- i+1
}

colnames(pods_Data) <- c("Year", "Pod_Num")

pod_Multinom_Sizes <- data.frame()
n <- 31
for(i in 1:n){ #generate pod sizes
  year <- i+1979
  s_Total <- orcaCensus$Size_best[orcaCensus$YEAR==year]
  s_Fecund_Unav <- orcaCensus$Females_fecund_unavailable[orcaCensus$YEAR==year]
  s_Births <- orcaCensus$Birth_count[orcaCensus$YEAR==year]
  s_Pregnancy <- orcaCensus$Pregnancy_count[orcaCensus$YEAR==year]
  
  size_Pod <- rmultinom(1, size = s_Total, 
                        prob = rep(1,pods_List[i]))
  size_Fecund_Unav_Pod <- rmultinom(1, size = s_Fecund_Unav, 
                                    prob = rep(1,pods_List[i]))
  size_Births_Pod <- rmultinom(1, size = s_Births, 
                                    prob = rep(1,pods_List[i]))
  size_Pregnancy_Pod <- rmultinom(1, size = s_Pregnancy, 
                                    prob = rep(1,pods_List[i]))
  
  pod_size_by_group <- data.frame(year, size_Pod, size_Fecund_Unav_Pod, 
                                  size_Births_Pod, size_Pregnancy_Pod)
  
  pod_Multinom_Sizes <- rbind(pod_Multinom_Sizes, pod_size_by_group)
}

pods_Data <- pods_Data %>% mutate(Pod_Size_Multinom = 
                                    pod_Multinom_Sizes$size_Pod)
pods_Data <- pods_Data %>% mutate(Fecund_Unav_Multinom = 
                                    pod_Multinom_Sizes$size_Fecund_Unav_Pod)
pods_Data <- pods_Data %>% mutate(Births_Multinom = 
                                    pod_Multinom_Sizes$size_Births_Pod)
pods_Data <- pods_Data %>% mutate(Pregnancy_Multinom = 
                                    pod_Multinom_Sizes$size_Pregnancy_Pod)
```

```{r Adding Salmon to Pod Data}
rep_salmon_data <- data.frame(chinook_density = c(), 
                                chum_density = c(), 
                                total_salmon = c())
  
x <- 1
i <- 1
while(x < 692){
  rep_salmon_data[c(x:((x-1)+pods_List[i])),1] <- salmon_data[i,2]
  rep_salmon_data[c(x:((x-1)+pods_List[i])),2] <- salmon_data[i,3]
  rep_salmon_data[c(x:((x-1)+pods_List[i])),3] <- salmon_data[i,4]
  x <- x+pods_List[i] #increase rows in repeated salmon data
  i <- i+1 #increase row in salmon data
}
rep_salmon_data <- rep_salmon_data[-c(693),]
colnames(rep_salmon_data) <- c("chinook_abundance", "chum_abundance", "total_salmon")


pods_Salmon_Data <- pods_Data %>% 
  mutate(Chinook_Abundance = rep_salmon_data$chinook_abundance)

pods_Salmon_Data <- pods_Salmon_Data %>% 
  mutate(Chum_Abundance = rep_salmon_data$chum_abundance)

pods_Salmon_Data <- pods_Salmon_Data %>% 
  mutate(Total_Salmon = rep_salmon_data$total_salmon)
```

# GLMM/LMM

## Checking Assumptions
```{r}
hist(pods_Salmon_Data$Fecund_Unav_Multinom)
hist(pods_Salmon_Data$Births_Multinom)
hist(pods_Salmon_Data$Pregnancy_Multinom)
hist(pods_Salmon_Data$Pod_Size_Multinom)
hist(pods_Salmon_Data$Total_Salmon)
# Fecundity unavialable, births, pregnancy is not normal, so GLMM
```

## Pod Model
```{r}
pod_Fecund_Unav_Model <- glmer(Fecund_Unav_Multinom~Total_Salmon+Pod_Size_Multinom+
                   (1|Pod_Num)+(1|Year), 
                 family = poisson, pods_Salmon_Data)
summary(pod_Fecund_Unav_Model)

pod_Births_Model <- glmer(Births_Multinom~Total_Salmon+Pod_Size_Multinom+
                   (1|Pod_Num)+(1|Year), 
                 family = poisson, pods_Salmon_Data)
summary(pod_Births_Model)

pod_Pregnancy_Model <- glmer(Pregnancy_Multinom~Total_Salmon+Pod_Size_Multinom+
                   (1|Pod_Num)+(1|Year), 
                 family = poisson, pods_Salmon_Data)
summary(pod_Pregnancy_Model)
```
For females with fecundity unavailable as a lactating females proxy, no variables are significant
For births as a lactating females proxy, salmon is significant
For pregnancy as a lactating females proxy, no variables are significant




*Note*: I'm not sure how to graph this lol i tried and failed

#Graphing Attempt #2

```{r}

pods_Salmon_Data %>% 
 mutate(testing = predict(pod_Fecund_Unav_Model)) %>%  #using model to predict pod fecundity (#not sure if this is right I wonder if it should be predicting like random effects)
  ggplot(pods_Salmon_Data, aes( x = Total_Salmon, y = Fecund_Unav_Multinom, colour = Year)) +
  geom_abline(aes(intercept = ))

ggplot(rikz_data, aes(x=NAP, y=Richness, colour=Beach)) +
  
  # fixed effect regression line (read values off of model output above)
  geom_abline(aes(intercept=6.5844, slope=-2.5757), linewidth=2) +
  
  # fitted values (i.e., regression lines) for each beach
  geom_line(aes(y=fit_InterceptOnly), linewidth=1) +
  geom_point(size=3)
```


## Total Population Model

I'm gonna see if just looking at the population as a whole matters

```{r}
by_Year_Salmon <- orcaCensus %>% filter(YEAR >= 1980 & YEAR <= 2010)
by_Year_Salmon <- by_Year_Salmon %>% select(YEAR, Size_best, 
                                            Females_fecund_unavailable, 
                                            Birth_count, Pregnancy_count)
by_Year_Salmon <- by_Year_Salmon %>% mutate(chinook_abundance = 
                                              salmon_data$chinook_density)
by_Year_Salmon <- by_Year_Salmon %>% mutate(chum_abundance = 
                                              salmon_data$chum_density)
by_Year_Salmon <- by_Year_Salmon %>% mutate(total_salmon = 
                                              salmon_data$total_salmon)

pop_Fecund_Unav_Model <- glmer(Females_fecund_unavailable~total_salmon+
                                 Size_best+(1|YEAR), 
                 family = poisson, by_Year_Salmon)
summary(pop_Fecund_Unav_Model)

pop_Births_Model <- glmer(Birth_count~total_salmon+
                            Size_best+(1|YEAR), 
                 family = poisson, by_Year_Salmon)
summary(pop_Births_Model)

pop_Pregnancy_Model <- glmer(Pregnancy_count~total_salmon+
                            Size_best+(1|YEAR), 
                 family = poisson, by_Year_Salmon)
summary(pop_Pregnancy_Model)
```
For females with fecundity unavailable as a lactating females proxy, population size significant
For births as a lactating females proxy, population size is significant
For pregnancies as a lactating females proxy, population size is significant


Pod Counts Per Year:
(From Fig. 1c)
1980: 20 pods
1981: 18 pods
1982: 18 pods
1983: 20 pods
1984: 21 pods
1985: 17 pods
1986: 16 pods
1987: 21 pods
1988: 21 pods
1989: 20 pods
1990: 21 pods
1991: 20 pods
1992: 24 pods
1993: 26 pods
1994: 25 pods
1995: 25 pods
1996: 25 pods
1997: 25 pods
1998: 24 pods
1999: 25 pods
2000: 25 pods
2001: 25 pods
2002: 24 pods
2003: 21 pods
2004: 22 pods
2005: 23 pods
2006: 23 pods
2007: 25 pods
2008: 25 pods
2009: 23 pods
2010: 24 pods



